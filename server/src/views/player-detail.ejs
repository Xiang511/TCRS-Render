<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/css/nav.css">
  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body class="bg-gray-100">
  <!-- Navigation -->
  <section class="nav-bg">
    <a href="https://SiteStates.com" title="ç«™é•·å·¥å…·" style="display: none;">
      <img src="https://SiteStates.com/show/image/33556.jpg" border="0" />
    </a>
    <input type="checkbox" id="menu-switch">
    <header class="main-header">
      <div class="logo">
        <a href="/">
          TCRS
        </a>
      </div>
      <label for="menu-switch" class="hb icon">
        <i class='bx bx-menu open'></i>
        <i class='bx bx-x close'></i>
      </label>
      <nav class="main-nav">
        <a class="click" href="/"><i class='bx bx-home-alt-2'></i> é¦–é </a>
        <a class="click" href="/players"><i class='bx bx-trophy mr-1'></i> ç”Ÿæ¶¯ç´€éŒ„</a>
        <a class="click" href="/players/leaderboard"><i class='bx bx-bar-chart-alt-2 mr-1'></i> å¤©æ¢¯ç´€éŒ„</a>
        <a class="click" href="/players/badges"><i class='bx bx-badge-check mr-1'></i> å¾½ç« ç´€éŒ„</a>
        <a class="click" href="/players/pathoflegend/Rankings"><i class='bx bx-crown mr-1'></i> åˆ†æåœ–è¡¨</a>
        <a class="click" href="/users/profile"><% if (user) { %><i class='bx bx-smile'></i> é—œæ–¼æˆ‘<% } else { %><i class='bx bx-ghost'></i> ç™»å…¥<% } %></a>
      </nav>
    </header>
  </section>
  <!-- Main Content -->
  <div class="container mx-auto  py-8">
    <!-- Player Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
            <%= player.name.charAt(0) %>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-gray-800"><%= player.name %></h1>
            <p class="text-gray-600"><%= player.tag %></p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-600">æœ€æ–°æ•¸æ“šæ™‚é–“</p>
          <p class="text-lg font-semibold text-indigo-600"><%= player.time %></p>
        </div>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
      <!-- Best Rank -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">æœ€ä½³æ’å</p>
            <p class="text-2xl font-bold text-indigo-600">
              <%= player.bestPathOfLegendSeasonResult?.rank || 'N/A' %>
            </p>
          </div>
          <i class='bx bx-crown text-4xl text-indigo-600'></i>
        </div>
      </div>

      <!-- Best Trophies -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">æœ€ä½³çç›ƒ</p>
            <p class="text-2xl font-bold text-purple-600">
              <%= player.bestPathOfLegendSeasonResult?.trophies || 'N/A' %>
            </p>
          </div>
          <i class='bx bx-trophy text-4xl text-purple-600'></i>
        </div>
      </div>

      <!-- Star Points -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">éŠç©æ™‚é–“</p>
            <p class="text-2xl font-bold text-yellow-600"><%= userdaysPlayed.years || 0 %>å¹´ <%= userdaysPlayed.weeks || 0 %>é€± <%= userdaysPlayed.days || 0 %>å¤©</p>
          </div>
          <i class='bx bx-hourglass text-4xl text-yellow-600'></i>
        </div>
      </div>

      <!-- Wins -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">å‹ç‡</p>
            <p class="text-2xl font-bold text-green-600"><%= ((player.wins/(player.wins + player.losses)).toFixed(3)) || 0 %></p>
          </div>
          <i class='bx bx-star text-4xl text-green-600'></i>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Rank History Chart -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
          <i class='bx bx-line-chart mr-2'></i>æ’åæ­·å²è¶¨å‹¢
        </h2>
        <div id="rankHistoryChart"></div>
        <!-- ğŸš§ ç¶­ä¿®ä¸­ -->
      </div>

      <!-- Trophy History Chart -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
          <i class='bx bx-trending-up mr-2'></i>çç›ƒæ­·å²è¶¨å‹¢
        </h2>
        <div id="trophyHistoryChart"></div>
        <!-- ğŸš§ ç¶­ä¿®ä¸­ -->
      </div>
    </div>

    <!-- Badges Progress -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">
        <i class='bx bx-badge-check mr-2'></i>å¾½ç« é€²åº¦
      </h2>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <% if (player.badges && Object.keys(player.badges).length > 0) { %>
        <% Object.entries(player.badges).forEach(([key, value]) => { %>
        <div class="p-4 bg-gray-50 rounded-lg">
          <div class="flex justify-between">
            <p class="text-sm text-gray-600 mb-1"><%= key %></p>
            <span class="text-sm text-gray-600 text-right ">Lv: <%= value.level || 1 %></span>
          </div>
          <div class="flex items-center">
            <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
              <div class="bg-indigo-600 h-2 rounded-full" style="width: <%= Math.min((value.progress/(value.target || 1) || 0) * 100, 100) %>%"></div>
            </div>
            <span class="text-sm font-semibold"><%= value.progress || value.level || 0 %></span>
          </div>
        </div>
        <% }); %>
        <% } else { %>
        <p class="col-span-full text-gray-500 text-center">ç„¡å¾½ç« è³‡æ–™</p>
        <% } %>
      </div>
    </div>

    <!-- Progress Details -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">
        <i class='bx bx-list-ul mr-2'></i>å¥‡å…µè³‡è¨Š
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <% if (player.progress && player.progress.size > 0) { %>
        <% Array.from(player.progress.entries()).forEach(([key, value]) => { %>
        <div class="p-4 bg-gray-50 rounded-lg">
          <div class="flex justify-between">
            <p class="text-sm text-gray-600 mb-1"><%= key || 'AutoChess' %></p>
            <span class="text-sm text-gray-600 text-right ">Arena: <%= value.arena.name || 0 %></span>
          </div>
          <div class="flex items-center">
            <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
              <div class="bg-indigo-600 h-2 rounded-full" style="width:100%"></div>
            </div>
            <span class="text-sm font-semibold"><%= value.trophies  || 0 %></span>
          </div>
        </div>
        <% }); %>
        <% } else { %>
        <p class="col-span-full text-gray-500 text-center">ç„¡é€²åº¦è³‡æ–™</p>
        <% } %>
      </div>
    </div>

    <!-- History Table -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">
        <i class='bx bx-history mr-2'></i>æ­·å²è¨˜éŒ„
      </h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ™‚é–“</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ’å</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çç›ƒ</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% history.slice(0, 30).forEach((record, index) => { %>
            <tr class="<%= index === 0 ? 'bg-indigo-50' : 'hover:bg-gray-50' %>">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <%= record.time %>
              <% if (index === 0) { %>
              <span class="ml-2 px-2 py-1 text-xs font-semibold rounded-full bg-indigo-600 text-white">æœ€æ–°</span>
              <% } %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <%= record.currentPathOfLegendSeasonResult?.rank || 'N/A' %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <%= record.currentPathOfLegendSeasonResult?.trophies || 'N/A' %>
              </td>
            </tr>
            <% }); %>
            <!-- ğŸš§ ç¶­ä¿®ä¸­ -->

          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Prepare history data
    const historyData = <%- JSON.stringify(history) %>;

    // Process data for charts
    const times = historyData.map(h => h.time).reverse();
    const currentPathOfLegendSeasonResult = {
      rank: historyData.map(h => h.currentPathOfLegendSeasonResult ? h.currentPathOfLegendSeasonResult.rank : null).reverse(),
      trophies: historyData.map(h => h.currentPathOfLegendSeasonResult ? h.currentPathOfLegendSeasonResult.trophies : null).reverse()
    };

    // Rank History Chart (ApexCharts)
    const rankChartOptions = {
      series: [{
        name: 'æ’å',
        data: currentPathOfLegendSeasonResult.rank || 10000
      }],
      chart: {
        type: 'line',
        height: 350,
        toolbar: {
          show: true
        },
        animations: {
          enabled: true,
          easing: 'easeinout',
          speed: 800
        }
      },
      stroke: {
        curve: 'smooth',
        width: 3
      },
      colors: ['#667eea'],
      markers: {
        size: 5,
        colors: ['#667eea'],
        strokeColors: '#fff',
        strokeWidth: 2,
        hover: {
          size: 7
        }
      },
      xaxis: {
        categories: times,
        labels: {
          rotate: -45,
          rotateAlways: true,
          style: {
            fontSize: '12px'
          }
        }
      },
      yaxis: {
        title: {
          text: 'æ’å'
        },
        labels: {
          formatter: function(val) {
            return val ? Math.round(val) : 'N/A';
          }
        }
      },
      tooltip: {
        y: {
          formatter: function(val) {
            return val ? 'æ’å ' + val : 'N/A';
          }
        }
      },
      grid: {
        borderColor: '#e7e7e7',
        strokeDashArray: 5
      },
    };

    const rankChart = new ApexCharts(document.querySelector("#rankHistoryChart"), rankChartOptions);
    rankChart.render();

    // Trophy History Chart (ApexCharts)
    const trophyChartOptions = {
      series: [{
      name: 'çç›ƒ',
      data: currentPathOfLegendSeasonResult.trophies || 0
      }],
      chart: {
      type: 'line',
      height: 350,
      toolbar: {
        show: true
      },
      animations: {
        enabled: true,
        easing: 'easeinout',
        speed: 800
      }
      },
      stroke: {
      curve: 'smooth',
      width: 3
      },
      colors: ['#764ba2'],
      markers: {
      size: 5,
      colors: ['#764ba2'],
      strokeColors: '#fff',
      strokeWidth: 2,
      hover: {
        size: 7
      }
      },
      dataLabels: {
      enabled: false
      },
      xaxis: {
      categories: times,
      labels: {
        rotate: -45,
        rotateAlways: true,
        style: {
        fontSize: '12px'
        }
      }
      },
      yaxis: {
      title: {
        text: 'çç›ƒæ•¸'
      },
      labels: {
        formatter: function(val) {
        return val ? Math.round(val) : 'N/A';
        }
      }
      },
      tooltip: {
      y: {
        formatter: function(val) {
        return val ? val + ' çç›ƒ' : 'N/A';
        }
      }
      },
      grid: {
      borderColor: '#e7e7e7',
      strokeDashArray: 5
      }
    };

    const trophyChart = new ApexCharts(document.querySelector("#trophyHistoryChart"), trophyChartOptions);
    trophyChart.render();
  </script>
</body>

</html>