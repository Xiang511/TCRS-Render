<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å€‹äººè³‡æ–™ - TCRS</title>
  <link rel="stylesheet" href="/css/nav.css">
  <link rel="stylesheet" href="/css/auth.css">
  <link rel="stylesheet" href="/css/background.css">
  <link rel="stylesheet" href="/css/profile.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

</head>

<body>
  <!-- å°èˆªæ¬„ -->
  <%- include('../layout/header') %>

  <!-- èƒŒæ™¯å‹•ç•« -->
  <div class="area">
    <ul class="circles">
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
    </ul>
  </div>

  <!-- å€‹äººè³‡æ–™å®¹å™¨ -->
  <div class="profile-container">
    <!-- å€‹äººè³‡æ–™é ­éƒ¨ -->
    <div class="profile-header">
      <div class="profile-header-content">
        <div class="profile-avatar">
          <%= user.name ? user.name.charAt(0).toUpperCase() : 'U' %>
        </div>
        <div class="profile-info">
          <h1><%= user.name || 'ä½¿ç”¨è€…' %></h1>
          <p><i class='bx bx-envelope'></i> <%= user.email %></p>
          <p><i class='bx bx-calendar'></i> åŠ å…¥æ™‚é–“ï¼š<%= new Date(user.createdAt).toLocaleDateString('zh-TW') %></p>
        </div>
      </div>
    </div>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="profile-stats">
      <div class="stat-card">
        <div class="stat-icon purple">
          <i class='bx bx-trophy'></i>
        </div>
        <h3>è¿½è¹¤ç©å®¶</h3>
          <p>ğŸš§ æš«ä¸é–‹æ”¾</p>
        <p class="stat-value"></p>
      </div>
      <div class="stat-card">
        <div class="stat-icon blue">
          <i class='bx bx-star'></i>
        </div>
        <h3>æ”¶è—å¾½ç« </h3>
          <p>ğŸš§ æš«ä¸é–‹æ”¾</p>
        <p class="stat-value"></p>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">
          <i class='bx bx-line-chart'></i>
        </div>
        <h3>è§€çœ‹æ¬¡æ•¸</h3>
          <p>ğŸš§ æš«ä¸é–‹æ”¾</p>
        <p class="stat-value"></p>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">
          <i class='bx bx-time'></i>
        </div>
        <h3>ä½¿ç”¨å¤©æ•¸</h3>
        <p class="stat-value"><%= Math.floor((new Date() - new Date(user.createdAt)) / (1000 * 60 * 60 * 24)) %></p>
      </div>
    </div>

    <!-- å€‹äººè³‡æ–™å€å¡Š -->
    <div class="profile-sections">
      <!-- å¸³æˆ¶è³‡è¨Š -->
      <div class="profile-section">
        <div class="section-header">
          <i class='bx bx-user-circle'></i>
          <h2>å¸³æˆ¶è³‡è¨Š</h2>
        </div>
        <div class="info-row">
          <span class="info-label">ä½¿ç”¨è€…åç¨±</span>
          <span class="info-value"><%= user.name || 'æœªè¨­å®š' %></span>
        </div>
        <div class="info-row">
          <span class="info-label">é›»å­éƒµä»¶</span>
          <span class="info-value"><%= user.email %></span>
        </div>
        <div class="info-row">
          <span class="info-label">å¸³æˆ¶ç‹€æ…‹</span>
          <span class="info-value" style="color: red;">
            <i class='bx bx-error'></i> æœªé©—è­‰
            <!-- style="color: #43e97b; -->
          </span>
        </div>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="openEditModal()">
            <i class='bx bx-edit'></i> ç·¨è¼¯è³‡æ–™
          </button>
          <button class="btn btn-secondary" onclick="openPasswordModal()">
            <i class='bx bx-lock'></i> ä¿®æ”¹å¯†ç¢¼
          </button>
        </div>
      </div>

      <!-- æœ€è¿‘æ´»å‹• -->
      <div class="profile-section">
        <div class="section-header">
          <i class='bx bx-history'></i>
          <h2>æœ€è¿‘æ´»å‹•</h2>
        </div>
        <div class="empty-state">
          <i class='bx bx-time-five'></i>
          <!-- <p>æš«ç„¡æ´»å‹•è¨˜éŒ„</p> -->
          <p>ğŸš§ æš«ä¸é–‹æ”¾</p>
        </div>
        <!-- æ´»å‹•åˆ—è¡¨ç¯„ä¾‹ï¼ˆç•¶æœ‰è³‡æ–™æ™‚é¡¯ç¤ºï¼‰
        <ul class="activity-list">
          <li class="activity-item">
            <div class="activity-icon">
              <i class='bx bx-search'></i>
            </div>
            <div class="activity-content">
              <h4>æŸ¥çœ‹ç©å®¶è³‡æ–™</h4>
              <p>2 å°æ™‚å‰</p>
            </div>
          </li>
        </ul>
        -->
      </div>
    </div>

    <!-- å±éšªå€åŸŸ -->
    <div class="profile-section" style="margin-top: 30px; border: 2px solid #ff4444;">
      <div class="section-header">
        <i class='bx bx-error' style="color: #ff4444;"></i>
        <h2 style="color: #ff4444;">å±éšªå€åŸŸ</h2>
      </div>
      <p style="color: #666; margin-bottom: 20px;">
        ç™»å‡ºæ‚¨çš„å¸³æˆ¶ä»¥ä¿è­·æ‚¨çš„å€‹äººè³‡æ–™å®‰å…¨ã€‚
      </p>
      <button class="btn btn-danger" onclick="confirmLogout()">
        <i class='bx bx-log-out'></i> ç™»å‡ºå¸³æˆ¶
      </button>
      <!-- <p style="color: #666; margin-bottom: 20px;">
        åˆªé™¤å¸³æˆ¶å¾Œï¼Œæ‚¨çš„æ‰€æœ‰è³‡æ–™å°‡ç„¡æ³•æ¢å¾©ã€‚è«‹è¬¹æ…æ“ä½œã€‚
      </p>
      <button class="btn btn-danger" onclick="confirmDelete()">
        <i class='bx bx-trash'></i> åˆªé™¤å¸³æˆ¶
      </button> -->
    </div>
  </div>

  <!-- ç·¨è¼¯è³‡æ–™ Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class='bx bx-edit'></i> ç·¨è¼¯å€‹äººè³‡æ–™</h2>
        <span class="close" onclick="closeEditModal()">&times;</span>
      </div>
      <form id="editForm">
        <div class="form-group">
          <label for="editName">ä½¿ç”¨è€…åç¨±</label>
          <input type="text" id="editName" name="name" value="<%= user.name %>" required>
        </div>
        <div class="action-buttons">
          <button type="submit" class="btn btn-primary">
            <i class='bx bx-save'></i> å„²å­˜è®Šæ›´
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
            <i class='bx bx-x'></i> å–æ¶ˆ
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ä¿®æ”¹å¯†ç¢¼ Modal -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class='bx bx-lock'></i> ä¿®æ”¹å¯†ç¢¼</h2>
        <span class="close" onclick="closePasswordModal()">&times;</span>
      </div>
      <form id="passwordForm">
        <div class="form-group">
          <label for="currentPassword">ç›®å‰å¯†ç¢¼</label>
          <input type="text" id="currentPassword" name="currentPassword" required>
        </div>
        <div class="form-group">
          <label for="newPassword">æ–°å¯†ç¢¼</label>
          <input type="text" id="Password" name="password" minlength="8" required>
        </div>
        <div class="form-group">
          <label for="confirmNewPassword">ç¢ºèªæ–°å¯†ç¢¼</label>
          <input type="text" id="confirmNewPassword" name="confirmPassword" minlength="8" required>
        </div>
        <div class="action-buttons">
          <button type="submit" class="btn btn-primary">
            <i class='bx bx-check'></i> æ›´æ–°å¯†ç¢¼
          </button>
          <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">
            <i class='bx bx-x'></i> å–æ¶ˆ
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Modal æ§åˆ¶
    function openEditModal() {
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    function openPasswordModal() {
      document.getElementById('passwordModal').style.display = 'block';
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
    }

    // é»æ“Š modal å¤–éƒ¨é—œé–‰
    // window.onclick = function(event) {
    //   const editModal = document.getElementById('editModal');
    //   const passwordModal = document.getElementById('passwordModal');
    //   if (event.target === editModal) {
    //     closeEditModal();
    //   }
    //   if (event.target === passwordModal) {
    //     closePasswordModal();
    //   }
    // }

    // ç·¨è¼¯è³‡æ–™è¡¨å–®æäº¤
    document.getElementById('editForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData(this);
      const data = {
        name: formData.get('name'),
      };

      try {
        const response = await fetch('/users/updateProfile', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === 'success') {
          alert('å€‹äººè³‡æ–™æ›´æ–°æˆåŠŸï¼');
          location.reload();
        } else {
          alert(result.message || 'æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      } catch (error) {
        alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    });

    // ä¿®æ”¹å¯†ç¢¼è¡¨å–®æäº¤
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData(this);
      const currentPassword = formData.get('currentPassword');
      const password = formData.get('password');
      const confirmPassword = formData.get('confirmPassword');

      if (!currentPassword) {
        alert('è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼ï¼');
        return;
      }

      if (password !== confirmPassword) {
        alert('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´ï¼');
        return;
      }

      if (password.length < 8) {
        alert('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 8 å€‹å­—å…ƒï¼');
        return;
      }

      try {
        const response = await fetch('/users/updatePassword', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            currentPassword: currentPassword,
            password: password,
            confirmNewPassword: confirmPassword
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          alert('å¯†ç¢¼æ›´æ–°æˆåŠŸï¼');
          closePasswordModal();
          this.reset();
        } else {
          alert(result.message || 'æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      } catch (error) {
        alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
        console.log(error);
      }
    });

    // ç™»å‡ºç¢ºèª
    function confirmLogout() {
      const confirmed = confirm('ç¢ºå®šè¦ç™»å‡ºå¸³æˆ¶å—ï¼Ÿ');

      if (confirmed) {
        window.location.href = '/users/logout';
      }
    }

    // åˆªé™¤å¸³æˆ¶ç¢ºèª
    function confirmDelete() {
      const confirmed = confirm('ç¢ºå®šè¦åˆªé™¤å¸³æˆ¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ï¼\n\nè«‹å†æ¬¡ç¢ºèªæ‚¨è¦åˆªé™¤å¸³æˆ¶ã€‚');

      if (confirmed) {
        const doubleConfirm = confirm('æœ€å¾Œç¢ºèªï¼šåˆªé™¤å¾Œæ‰€æœ‰è³‡æ–™å°‡æ°¸ä¹…æ¶ˆå¤±ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ');

        if (doubleConfirm) {
          // TODO: å¯¦ä½œåˆªé™¤å¸³æˆ¶ API
          alert('å¸³æˆ¶åˆªé™¤åŠŸèƒ½é–‹ç™¼ä¸­...');
        }
      }
    }

    // é é¢è¼‰å…¥å‹•ç•«
    window.addEventListener('load', function() {
      document.querySelector('.profile-container').style.animation = 'slideUp 0.6s ease-out';
    });
  </script>
</body>

</html>